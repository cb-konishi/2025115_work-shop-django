{% extends "base.html" %}
{% block title %}å•†å“ä¸€è¦§ | Minimal Shop{% endblock %}

{% block content %}
<!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ -->
<div class="page-header">
  <h2 class="page-title">å•†å“ä¸€è¦§</h2>
  <p class="page-description">å³é¸ã•ã‚ŒãŸå•†å“ã‚’ã”è¦§ãã ã•ã„</p>
</div>

{% if products %}
  <!-- å•†å“ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªå•†å“è¡¨ç¤º -->
  <div class="product-grid">
    {% for product in products %}
      <article class="product-card">
        <!-- å•†å“ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼: å°†æ¥çš„ã«ç”»åƒã‚’è¿½åŠ å¯èƒ½ -->
        <div class="product-image-placeholder">
          ğŸ“¦
        </div>
        
        <!-- å•†å“æƒ…å ± -->
        <div class="product-info">
          <!-- å•†å“ID: ç®¡ç†ç”¨ã®è­˜åˆ¥ç•ªå· -->
          <span class="product-id">ID: {{ product.id }}</span>
          
          <!-- å•†å“å -->
          <h3 class="product-name">{{ product.name }}</h3>
          
          <!-- å•†å“ä¾¡æ ¼: ç›®ç«‹ã¤ã‚ˆã†ã«å¤§ããè¡¨ç¤º 
               floatformat:0 - æ—¥æœ¬å††ã¯é€šå¸¸å°æ•°ç‚¹ä»¥ä¸‹ã‚’è¡¨ç¤ºã—ãªã„ãŸã‚æ•´æ•°åŒ– -->
          <p class="product-price">Â¥{{ product.price|floatformat:0 }}</p>
          
          <!-- ã‚«ãƒ¼ãƒˆã«è¿½åŠ ãƒœã‚¿ãƒ³ -->
          <button class="btn-add-to-cart" data-product-id="{{ product.id }}">
            ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹
          </button>
        </div>
      </article>
    {% endfor %}
  </div>
{% else %}
  <!-- ç©ºçŠ¶æ…‹: å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã®è¡¨ç¤º -->
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ“­</div>
    <h3 class="empty-state-title">å•†å“ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
    <p class="empty-state-description">
      ç®¡ç†ç”»é¢ã‹ã‚‰å•†å“ã‚’è¿½åŠ ã—ã¦ã€ã‚·ãƒ§ãƒƒãƒ—ã‚’å……å®Ÿã•ã›ã¾ã—ã‚‡ã†
    </p>
    <a href="/admin/" class="empty-state-link" target="_blank" rel="noopener">
      ç®¡ç†ç”»é¢ã‚’é–‹ã
    </a>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
  const addButtons = document.querySelectorAll('.btn-add-to-cart');
  
  addButtons.forEach(button => {
    button.addEventListener('click', function() {
      const productId = this.dataset.productId;
      
      // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = getCookie('csrftoken');
      
      // ã‚«ãƒ¼ãƒˆã«è¿½åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      fetch(`/products/cart/add/${productId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          // ã‚«ãƒ¼ãƒˆæ•°ã‚’æ›´æ–°
          const cartCountElement = document.querySelector('.cart-count');
          if (cartCountElement) {
            cartCountElement.textContent = data.cart_count;
          }
        } else {
          alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ã‚«ãƒ¼ãƒˆã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    });
  });
});

// CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}