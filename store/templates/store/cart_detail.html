{% extends "base.html" %}
{% block title %}ã‚«ãƒ¼ãƒˆ | Minimal Shop{% endblock %}

{% block content %}
<!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ -->
<div class="page-header">
  <h2 class="page-title">ã‚«ãƒ¼ãƒˆ</h2>
  <p class="page-description">é¸æŠã—ãŸå•†å“ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
</div>

{% if cart_items %}
  <!-- ã‚«ãƒ¼ãƒˆå†…å®¹ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="cart-container">
    <table class="cart-table">
      <thead>
        <tr>
          <th>å•†å“å</th>
          <th>ä¾¡æ ¼</th>
          <th>æ•°é‡</th>
          <th>å°è¨ˆ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr data-item-id="{{ item.id }}">
          <td class="cart-product-name">{{ item.product.name }}</td>
          <td class="cart-product-price">Â¥{{ item.product.price|floatformat:0 }}</td>
          <td class="cart-quantity">
            <form class="quantity-form" data-item-id="{{ item.id }}">
              {% csrf_token %}
              <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="quantity-input">
              <button type="submit" class="btn-update">æ›´æ–°</button>
            </form>
          </td>
          <td class="cart-subtotal">Â¥{{ item.get_subtotal|floatformat:0 }}</td>
          <td>
            <button class="btn-remove" data-item-id="{{ item.id }}">å‰Šé™¤</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <!-- ã‚«ãƒ¼ãƒˆåˆè¨ˆ -->
    <div class="cart-summary">
      <div class="summary-row">
        <span class="summary-label">åˆè¨ˆæ•°é‡:</span>
        <span class="summary-value" id="total-quantity">{{ total_quantity }}ç‚¹</span>
      </div>
      <div class="summary-row summary-total">
        <span class="summary-label">åˆè¨ˆé‡‘é¡:</span>
        <span class="summary-value" id="total-price">Â¥{{ total_price|floatformat:0 }}</span>
      </div>
      <div class="cart-actions">
        <a href="{% url 'product_list' %}" class="btn-continue">è²·ã„ç‰©ã‚’ç¶šã‘ã‚‹</a>
        <button class="btn-checkout" disabled>æ³¨æ–‡ã«é€²ã‚€ï¼ˆæœªå®Ÿè£…ï¼‰</button>
      </div>
    </div>
  </div>
{% else %}
  <!-- ç©ºçŠ¶æ…‹: ã‚«ãƒ¼ãƒˆãŒç©ºã®å ´åˆ -->
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ›’</div>
    <h3 class="empty-state-title">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</h3>
    <p class="empty-state-description">
      å•†å“ä¸€è¦§ãƒšãƒ¼ã‚¸ã‹ã‚‰å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„
    </p>
    <a href="{% url 'product_list' %}" class="empty-state-link">
      å•†å“ä¸€è¦§ã‚’è¦‹ã‚‹
    </a>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡æ›´æ–°å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
  // æ•°é‡æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
  const quantityForms = document.querySelectorAll('.quantity-form');
  quantityForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const itemId = this.dataset.itemId;
      const quantity = this.querySelector('input[name="quantity"]').value;
      const csrfToken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;
      
      // æ•°é‡æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      fetch(`/products/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `quantity=${quantity}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // å°è¨ˆã‚’æ›´æ–°
          const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
          row.querySelector('.cart-subtotal').textContent = `Â¥${Math.floor(data.subtotal)}`;
          
          // åˆè¨ˆã‚’æ›´æ–°
          document.getElementById('total-price').textContent = `Â¥${Math.floor(data.cart_total)}`;
          document.getElementById('total-quantity').textContent = `${data.cart_count}ç‚¹`;
          
          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚«ãƒ¼ãƒˆæ•°ã‚’æ›´æ–°
          const cartCountElement = document.querySelector('.cart-count');
          if (cartCountElement) {
            cartCountElement.textContent = data.cart_count;
          }
        } else {
          alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('æ•°é‡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    });
  });
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†
  const removeButtons = document.querySelectorAll('.btn-remove');
  removeButtons.forEach(button => {
    button.addEventListener('click', function() {
      if (!confirm('ã“ã®å•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      const itemId = this.dataset.itemId;
      const csrfToken = getCookie('csrftoken');
      
      // å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      fetch(`/products/cart/remove/${itemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // è¡Œã‚’å‰Šé™¤
          const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
          row.remove();
          
          // åˆè¨ˆã‚’æ›´æ–°
          document.getElementById('total-price').textContent = `Â¥${Math.floor(data.cart_total)}`;
          document.getElementById('total-quantity').textContent = `${data.cart_count}ç‚¹`;
          
          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚«ãƒ¼ãƒˆæ•°ã‚’æ›´æ–°
          const cartCountElement = document.querySelector('.cart-count');
          if (cartCountElement) {
            cartCountElement.textContent = data.cart_count;
          }
          
          // ã‚«ãƒ¼ãƒˆãŒç©ºã«ãªã£ãŸå ´åˆã¯ãƒªãƒ­ãƒ¼ãƒ‰
          const tbody = document.querySelector('.cart-table tbody');
          if (tbody.children.length === 0) {
            location.reload();
          }
        } else {
          alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    });
  });
});

// CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
